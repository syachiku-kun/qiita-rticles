---
title: 【2/5】GitLab+GitLab Runner を構築する道のり
tags:
  - Git
  - PowerShell
  - GitLab
  - Hyper-V
  - CICD
private: false
updated_at: '2025-12-30T21:34:53+09:00'
id: 023019f06e041fcfe907
organization_url_name: null
slide: false
ignorePublish: false
---

# 1. 概要

ここでは、Hyper-V を使って仮想マシンを構築します。
折角なので、マシン情報を標準化するためにスクリプトを用意します。
道のりをたどり始めたばかりのところです。

# 2. ロードマップ

- 1 全体的な説明

https://qiita.com/cipher-31186/items/1e4add84ae5be69ee782

- 2 仮想マシンを構築 <font color="red">**★ 今ここ**</font>

https://qiita.com/cipher-31186/items/023019f06e041fcfe907

- 3 GitLab の導入と GitLab Runner の導入

https://qiita.com/cipher-31186/items/cbfb3029ee5c046eb134

- 4 GitLab Runner 設定

https://qiita.com/cipher-31186/items/d803e3a73b1ec7aeefea

- 5 テストラン

https://qiita.com/cipher-31186/items/634f35c1bb9e9399e6b2

# 3. 構築

ここではいくつかの仮想マシンを構築するので、画面をポチポチするのはかったるいなぁと考えていました。  
当初の予定では愚直に画面操作で作る予定でしたが、調べたところ Powershell で実現可能だと！  
まあよく考えたら Hyper-V って「Windows の機能の有効化または無効化」から有効にできるから、Windows でコントロールしやすいだろうし。  
利用した PowerShell は後に記載します。

## 3.1. 前提条件

- ホスト PC で Hyper-V が有効にされていること。
- Hyper-V で外部スイッチが設定されていること。

- 用語説明

| 用語         | 説明                                                                                                       |
| ------------ | ---------------------------------------------------------------------------------------------------------- |
| 外部スイッチ | ホスト PC 以外のマシンから、ホスト PC の NIC を介して仮想マシンへ接続できるようにする設定。                |
| NIC          | ネットワークインターフェースという物理的な部品です。LAN ケーブルを指したり WiFi 接続できるようになります。 |

## 3.2. 仮想マシン構築時の引数

- 各マシンはこのような引数で構築させました。
- ISO ファイル置き場所などの、実行者によって確実に異なる引数は「略」としています。

| 用語                     | 説明                           | GitLab 用      | GitLab Runner (linux) 用 | GitLab Runner (windows) 用 |
| ------------------------ | ------------------------------ | -------------- | ------------------------ | -------------------------- |
| OsName                   | OS 名                          | Ubuntu Desktop | Ubuntu Desktop           | Windows Server             |
| OsVersion                | OS バージョン                  | 24.04.3        | 24.04.3                  | 2019                       |
| VmPurpose                | 入れるアプリ名などの目的を示す | GitLab         | GitLab Runner on Linux   | GitLab Runner on Windows   |
| VmMemoryStartupGigaBytes | 仮想マシンのメモリ(GB 単位)    | 16             | 4                        | 4                          |
| IsoPath                  | OS の iso ファイルのフルパス   | 略             | 略                       | 略                         |
| VMPath                   | 仮想マシン保存場所のフルパス   | 略             | 略                       | 略                         |
| VHDGigaBytesSize         | 仮想 HD のサイズ(GB 単位)      | 50             | 50                       | 50                         |
| VMSwitch                 | 仮想マシンが利用するスイッチ名 | 略             | 略                       | 略                         |
| VMCpuCount               | 仮想マシンの仮想プロセッサ数   | 8              | 4                        | 4                          |

## 3.3. 利用したスクリプト

- より細かく見たいかたは、GitHub に[PSS スクリプト](https://github.com/syachiku-kun/survey-ci-cd/blob/main/01-setup-vm/setup-vm-with-hyperv.ps1)と[スクリプト実行時のログ](https://github.com/syachiku-kun/survey-ci-cd/blob/main/01-setup-vm/setup-vm-with-hyperv_20251229_104312.log)を載せています。
- このログ出力方法は構築前後の比較がしにくいので、全体を Transcript で、前後の結果を各々別ファイルに書き出したりすればいい感じになると思っています。気が向けば改良しようかな...

```powershell
Set-StrictMode -Version 3.0
$PSDefaultParameterValues["*:Encoding"] = "utf8"
$OutputEncoding = [Text.Encoding]::UTF8
[Console]::OutputEncoding = [Text.Encoding]::UTF8
$FileNameWithoutExtension = [System.IO.Path]::GetFileNameWithoutExtension($MyInvocation.MyCommand.name);
$FileLocation = (Split-Path -Path $MyInvocation.MyCommand.Path -Parent)
$Now = Get-Date -Format yyyyMMdd_HHmmss
$LogFileName = "${FileNameWithoutExtension}_${Now}.log"
$LogFile = Join-Path -Path $FileLocation -ChildPath $LogFileName
Start-Transcript $LogFile -append

#----------------------------------------------
# Define variables
# $OsName os name will be used in VM
# $OsVersion os version will be used in VM
# $VmPurpose purpose of the VM
# $VMPath if you want to check existing VMs
# PS C:\Users\xxxxx> Get-VM | Select-Object Name, Path | Format-Table -AutoSize
# Name                   Path
# ----                   ----
# CentOS Stream 9        E:\ProgramData\Microsoft\Windows\Hyper-V\CentOS Stream 9
# Debian 12.7.0          E:\ProgramData\Microsoft\Windows\Hyper-V\Debian 12.7.0
#
# $IsoPath path to the OS ISO file
# $VHDPath path to the VHDX file(auto completed)
# $VMSwitch existing virtual switch name
#----------------------------------------------
$OsName = "Ubuntu Desktop"
$OsVersion = "24.04.3"
$VmPurpose = "GitLab"
$VmName = "${OsName} ${OsVersion}(${VmPurpose})"
$VmMemoryStartupGigaBytes = 4
$IsoPath = "C:\Users\xxxxx\Desktop\system\os\Ubuntu Desktop\ubuntu-24.04.3-desktop-amd64.iso"
$VMPath = "E:\ProgramData\Microsoft\Windows\Hyper-V"
$VHDPath = "$VMPath\$VMName\Virtual Hard Disks\$VMName.vhdx"
$VHDGigaBytesSize = 50
$VMSwitch = "Hyper-V仮想スイッチ（外部）"
$VMCpuCount = 2

# get statue(before)
Get-VM | Select-Object Name, Path | Out-String -Width 4096
Get-Variable | Out-String -Width 4096

# create folder for VM
New-Item -ItemType Directory -Path $VMPath -Force

# create VM(generation 2)
# https://learn.microsoft.com/ja-jp/powershell/module/hyper-v/new-vm
New-VM -Name $VMName `
    -Generation 2 `
    -Path $VMPath `
    -MemoryStartupBytes ([UInt64]$VmMemoryStartupGigaBytes * 1GB) `
    -NewVHDPath $VHDPath `
    -NewVHDSizeBytes ([UInt64]$VHDGigaBytesSize * 1GB) `
    -SwitchName $VMSwitch

# set VM
# https://learn.microsoft.com/ja-jp/powershell/module/hyper-v/set-vm
Set-VM -VMName $vmName `
    -ProcessorCount $VMCpuCount `
    -StaticMemory -AutomaticCheckpointsEnabled $false

# set DVD drive
# https://learn.microsoft.com/ja-jp/powershell/module/hyper-v/add-vmdvddrive
Add-VMDvdDrive -VMName $VMName `
    -Path $IsoPath

# set firmware(boot order, secure boot)
# https://learn.microsoft.com/ja-jp/powershell/module/hyper-v/set-vmfirmware
Set-VMFirmware -VMName $VMName `
    -FirstBootDevice (Get-VMDvdDrive -VMName $VMName) `
    -EnableSecureBoot Off

# create initial checkpoint
# https://learn.microsoft.com/ja-jp/powershell/module/hyper-v/checkpoint-vm
Checkpoint-VM -Name $VMName `
    -SnapshotName "Init Checkpoint"

# get statue(after)
Get-VM | Select-Object Name, Path | Out-String -Width 4096
Get-Variable | Out-String -Width 4096

# start up the VM
# https://learn.microsoft.com/ja-jp/powershell/module/hyper-v/start-vm
Start-VM -Name $VMName

Write-Host "Completed. Press Enter to exit…" -ForegroundColor Yellow
[void] (Read-Host)

Stop-Transcript
```

- このように実行

```
PowerShell 7.5.4
PS C:\Users\whoami> ."C:\Users\whoami\Desktop\git\repositories\syachiku-kun\survey-ci-cd\01-setup-vm\setup-vm-with-hyperv.ps1"
Transcript started, output file is C:\Users\whoami\Desktop\git\repositories\syachiku-kun\survey-ci-cd\01-setup-vm\setup-vm-with-hyperv_20251229_104312.log

Name                   Path
----                   ----
CentOS Stream 9        E:\ProgramData\Microsoft\Windows\Hyper-V\CentOS Stream 9

～～～中略～～～

Completed. Press Enter to exit…                                                                                         ]

Transcript stopped, output file is C:\Users\whoami\Desktop\git\repositories\syachiku-kun\survey-ci-cd\01-setup-vm\setup-vm-with-hyperv_20251229_104312.log

PS C:\Users\whoami>
```

# 4. OS セットアップ

## 4.1. OS インストール

OS インストール時のスクショは採取しました(地味だけど設定を忘れたらめんどいので...)。
量がおおいので折りたたんでいます。
ubuntu については`autoinstall.yaml`とやらを使ってインストールができるようだ。調べた限り結構学習コストが高そうなので、今回は見送ることにした(GRUB とか出てきたし...)。  
気に入らない点があるといえば、gitlab-runner とホスト名が被ってしまったことだ。これはスルーして頂ければ…  
運用上は IP アドレスでしか呼び出さないから問題は起きないだろう。

### 4.1.1. Ubuntu Desktop 24.04.3(GitLab) の場合

再起動時の`failed unmounting cdrom.mount - /cdrom`エラーは無視しても大丈夫です。
OS インストールのためにインストールメディアが使われているために、アンマウント失敗しただけのことです。  
Hyper-V で仮想マシンの設定から、`ハードウェア > SCSIコントローラー > DVDドライブ > メディア`をなしに切り替えましょう。

<details><summary>各設定のスクショとコメント</summary>

![setup-vm-with-hyperv_GitLab-01.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/87cae52e-48d2-4f71-af7d-2b01aa4f1910.png)
![setup-vm-with-hyperv_GitLab-02.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/9ae40cc7-298f-4227-a968-a5d4c9efec0c.png)
![setup-vm-with-hyperv_GitLab-03.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/e2206dd8-e75e-42ac-b05f-ae142269f4c5.png)
![setup-vm-with-hyperv_GitLab-04.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/8e74e685-8a46-4177-9baa-610bae05f961.png)
![setup-vm-with-hyperv_GitLab-05.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/5a4b6ed5-57b7-4293-9292-a71bf4972f5d.png)
![setup-vm-with-hyperv_GitLab-06.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/0b1f8ab0-5154-4238-8735-577b65d53a91.png)
![setup-vm-with-hyperv_GitLab-07.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/f6f83918-60bf-4a95-a90d-0d5496cbc73b.png)
![setup-vm-with-hyperv_GitLab-08.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/b55f88a2-92a0-42f6-ac0a-b1392a5dab4d.png)
![setup-vm-with-hyperv_GitLab-09.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/2925675c-4eaa-4b45-95bc-609498e1658a.png)
![setup-vm-with-hyperv_GitLab-10.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/5996ba21-ed5a-4869-8047-82dc291dad90.png)
![setup-vm-with-hyperv_GitLab-11.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/8055d93f-4ff4-481f-bfee-056495fa992d.png)
![setup-vm-with-hyperv_GitLab-12.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/ca3f9a26-8f5d-4c28-80af-00e9c40e2523.png)
![setup-vm-with-hyperv_GitLab-13.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/71a426da-7ece-492f-82ee-95e5b697d1f0.png)
![setup-vm-with-hyperv_GitLab-14.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/9ccc72e6-d15f-438d-b013-3ed98e166112.png)
![setup-vm-with-hyperv_GitLab-15.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/38bf50a8-0b52-445e-bf06-1944b25e3781.png)
![setup-vm-with-hyperv_GitLab-16.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/8682e097-250c-407a-886b-a44a568874f7.png)
![setup-vm-with-hyperv_GitLab-17.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/3d8897d3-341f-45f2-ae37-c4caac8f7ad6.png)

</details>

### 4.1.2. Ubuntu Desktop 24.04.3(GitLab Runner on Linux) の場合

再起動時の`failed unmounting cdrom.mount - /cdrom`エラーは同じく予想していたのですが、後続のエラーについてはわかりませんでした。  
[こちら](https://www.debian.org/releases/forky/s390x/apds01.ja.html)を見ると、sr0 は CdRom だから同じようなことを言っているのだろうか。有識者様、ご教授いただければ幸いです。

<details><summary>各設定のスクショとコメント</summary>

![setup-vm-with-hyperv_GitLab Runner (linux)-01.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/efb39fbb-f6b8-4fc2-b8f3-d5689283a2b7.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-02.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/09e9698c-0a21-489e-b6e6-19dd6ddb6262.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-03.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/acac2043-4566-4339-9825-0141fcad1405.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-04.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/0fd49163-4dc3-40a8-9dcc-d9497924e10a.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-05.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/61dad7d5-da51-419a-b30a-5120a6577dcf.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-06.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/a1dd7112-4944-498c-8c89-f2a2f29e2049.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-07.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/5936bce2-5617-46be-91c9-8c9c6c27920f.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-08.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/950f9514-7b99-41c3-bf95-5feb496aae23.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-09.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/2ac82ab1-4a01-48ad-a9c3-271301b79d7b.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-10.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/b455eaff-098d-4349-89d4-3449dec80277.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-11.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/d22baca2-488b-4745-b113-b8b3871eef89.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-12.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/456784b3-d655-4922-b5e1-0a30b28ed5ac.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-13.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/de9a9fc7-3152-4f1c-9c9e-98dd6e9a843c.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-14.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/80fb12bc-a212-4fa1-a3ea-df582cbc5763.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-15.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/69b47e3a-3e3c-4285-9938-a187a3fe81ea.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-16.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/5723aeb2-5a44-47af-a37f-12f057b3f3b2.png)
![setup-vm-with-hyperv_GitLab Runner (linux)-17.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/bfd92f88-d3f3-4bb2-a8e5-9986fd89ec53.png)

</details>

### 4.1.3. Windows Server 2019(GitLab Runner on Windows) の場合

Windows はホスト名を変える作業も含めます。Ubuntu みたいに OS インストール作業に含めてほしいものです。  
1 枚目の`Microsoft Hyper-V UEFI`とある画面は、メディアディスクを刺した状態の OS インストール前仮想マシンを起動してしばらく経つと勝手に遷移します。Enter キーなどの何かのキーを起動後に素早く押すと 2 枚目の画面が表示されます。

<details><summary>各設定のスクショとコメント</summary>

![setup-vm-with-hyperv_GitLab Runner (windows)-01.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/cb75d914-8a90-4fd1-bb39-562f5a328c9b.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-02.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/e7f148ec-a125-4af5-839d-f42c8262e375.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-03.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/03d65527-e8f6-488a-9dd3-166c743e8d88.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-04.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/915761c2-bcc6-446f-ac43-7150541b5bfa.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-05.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/a0a2b0b5-a983-4c88-9b5c-e61a94d8e994.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-06.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/5900264e-eab4-4d22-8687-b99232682821.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-07.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/89fbd807-bfa4-4f8e-b59b-586435b7c26d.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-08.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/14d2deaa-859a-4552-b521-3af5e5272196.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-09.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/ad627624-1a7e-4ad1-b913-ff08666f991f.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-10.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/5511c752-5557-404f-b988-47d5c6006c4e.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-11.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/8de25653-3d34-4f07-9069-9e5d8e79f375.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-12.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/2529a458-3eb3-44df-8c17-a075b5fe7105.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-13.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/caf3239b-7a22-48cb-8dad-1225639704c6.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-14.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/270923d3-c671-41e3-95df-a002d61d3d69.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-15.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/58f4da72-a1be-413e-9f20-0a4abec292dd.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-16.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/b46c2498-b5c0-48e0-a4b1-c96872f90a19.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-17.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/17e53568-d14b-44fe-b025-783dcad234b9.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-18.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/7901c23d-3fc2-452e-9c95-ccfd1130d7bf.png)
![setup-vm-with-hyperv_GitLab Runner (windows)-19.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/56ecb163-94b3-4230-8117-69a954ebc32f.png)

</details>

## 4.2. 静的 IP 割り当て＆実機から仮想マシンへの疎通確認

### 4.2.1. FW 停止

- 個人用＆めんどくさいので、いったん FW をとめちゃいます...

  - **会社ではマネしないでください！**

1. Linux 側では、`sudo systemctl stop ufw`でぶった切りましょう。

![setup-vm-network-linux-00.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/ac514de7-223f-4176-8847-4e3507898bb1.png)

2. Windows 側では、`設定 > 更新とセキュリティ > Windows セキュリティ > ファイアウォールとネットワーク保護`にある各々の項目(ドメインネットワークなど)で、`Microsoft Defender ファイアウォール`を OFF にすることで無効化できます。

- もしくは PowerShell から`Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False -PassThru`で一発です。

![setup-vm-network-windows-00.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/1492617a-14b5-47c1-b663-c9846a59dcdc.png)

### 4.2.2. Linux 側で静的 IP 割り当て

1. まず DHCP サーバー側で、DHCP クライアントがどうなっているか確認します。

- 動的にどの IP アドレスが割り振られているかを確認します。
- 177, 178, 179 がそれぞれ割り振られていますね。
- 179 は WindowsOS セットアップ時に確認済なので、3 台の仮想マシン各々の IP アドレスを特定できました。

![setup-vm-network-01.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/e22524c6-f48e-4770-a0aa-5f813b43cd99.png)

2. `Ubuntu Desktop 24.04.3(GitLab)`仮想マシンで、`192.168.0.177`を固定 IP アドレスにする設定をします。有線設定を開きます。
   ![setup-vm-network-linux-01.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/80ed4564-b967-41a4-ad51-64b3db0bfce1.png)

3. `有線`項目の右端にある歯車アイコンをクリックします。

![setup-vm-network-linux-02.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/cdc8192a-a4ab-4528-bbbc-015488f42d33.png)

4. `有線 > 詳細`タブが開き、ネットワーク設定を確認できます。自分の環境のスクショを貼っておきますが、実際は各環境によって異なります。

![setup-vm-network-linux-03.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/8ee637d6-6727-4df2-9461-ff32e7a85d86.png)

5. IPv4 メソッドを手動に切り替え、`アドレス > アドレス`項目に固定したい IPV4 アドレスを記載します。それ以外の項目と DNS は、各自ルーターの設定などをご確認ください。
   ![setup-vm-network-linux-04.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/54e98806-b6db-4ffd-9be6-1faf691f5a5d.png)

6. 結果確認

- 初めに`ip`コマンドで状態確認をします。`ifconfig`はまだ入っていないのでこちらのコマンドでチェックします。

![setup-vm-network-linux-05.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/3e56cd79-1a4a-4c53-91d5-f9f4d628a322.png)

- いったん仮想マシンを再起動し、再度 IPv4 アドレスを確認します。うまく割り振られていないならば、再起動時に DHCP サーバーがまたアドレスを割りなおすので、IPv4 アドレスが変わってしまいます。
  - `eth0 > inet`は`192.168.0.177`で固定されてますね。

```
gitlab@gitlab:~$ ip addr show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:15:5d:55:01:11 brd ff:ff:ff:ff:ff:ff
    inet 192.168.0.177/24 brd 192.168.0.255 scope global noprefixroute eth0
       valid_lft forever preferred_lft forever
gitlab@gitlab:~$
```

7. `Ubuntu Desktop 24.04.3(GitLab Runner on Linux)`仮想マシンで、`192.168.0.178`を固定 IP アドレスにする設定をします。作業は先ほどと同じです。

### 4.2.3. Windows 側で静的 IP 割り当て

1. `Windows Server 2019(GitLab Runner on Windows)`仮想マシンで、`192.168.0.178`を固定 IP アドレスにする設定をします。作業は先ほどと同じです。

![setup-vm-network-windows-01.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/556580/a181a734-3f05-46bc-824d-9723365d517d.png)

- 用語説明

| 用語              | 説明                                                                                                                                                              |
| ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| DHCP              | Dynamic Host Configuration Protocol の略称です。動的に設定を割り振ってくれるプロトコルです。詳細は[こちら](https://www.infraexpert.com/study/tcpip13.html) にも。 |
| DHCP サーバー     | 動的に設定を**割り当てる側**です。平たく言えばルーター等が当てはまります。詳細は[こちら](https://www.infraexpert.com/info/server11.html) にも。                   |
| DHCP クライアント | 動的に設定を**割り当てられる側**です。ルーター等に繋いでいる PC やスマホなどもろもろが当てはまります。                                                            |

### 4.2.2. 疎通確認

1. 別マシンから ping を通せたらヨシ！

```
Microsoft Windows [Version 10.0.26200.7462]
(c) Microsoft Corporation. All rights reserved.

C:\Users\xxxxx>ping 192.168.0.177

192.168.0.177 に ping を送信しています 32 バイトのデータ:
192.168.0.177 からの応答: バイト数 =32 時間 <1ms TTL=64
192.168.0.177 からの応答: バイト数 =32 時間 <1ms TTL=64
192.168.0.177 からの応答: バイト数 =32 時間 <1ms TTL=64
192.168.0.177 からの応答: バイト数 =32 時間 <1ms TTL=64

192.168.0.177 の ping 統計:
    パケット数: 送信 = 4、受信 = 4、損失 = 0 (0% の損失)、
ラウンド トリップの概算時間 (ミリ秒):
    最小 = 0ms、最大 = 0ms、平均 = 0ms

C:\Users\xxxxx>ping 192.168.0.178

192.168.0.178 に ping を送信しています 32 バイトのデータ:
192.168.0.178 からの応答: バイト数 =32 時間 <1ms TTL=64
192.168.0.178 からの応答: バイト数 =32 時間 <1ms TTL=64
192.168.0.178 からの応答: バイト数 =32 時間 <1ms TTL=64
192.168.0.178 からの応答: バイト数 =32 時間 <1ms TTL=64

192.168.0.178 の ping 統計:
    パケット数: 送信 = 4、受信 = 4、損失 = 0 (0% の損失)、
ラウンド トリップの概算時間 (ミリ秒):
    最小 = 0ms、最大 = 0ms、平均 = 0ms

C:\Users\xxxxx>ping 192.168.0.179

192.168.0.179 に ping を送信しています 32 バイトのデータ:
192.168.0.179 からの応答: バイト数 =32 時間 <1ms TTL=128
192.168.0.179 からの応答: バイト数 =32 時間 <1ms TTL=128
192.168.0.179 からの応答: バイト数 =32 時間 <1ms TTL=128
192.168.0.179 からの応答: バイト数 =32 時間 <1ms TTL=128

192.168.0.179 の ping 統計:
    パケット数: 送信 = 4、受信 = 4、損失 = 0 (0% の損失)、
ラウンド トリップの概算時間 (ミリ秒):
    最小 = 0ms、最大 = 0ms、平均 = 0ms

C:\Users\xxxxx>
```

# 5. まとめ

- この作業をしたことで、下記に含まれる派手なピンク部分のOS構築が終わりました。
- 次はこの中身のアプリを導入します。

```mermaid
%%{ init: { "flowchart": { "curve": "bumpX" } } }%%
flowchart LR
  CL["Client"]
  subgraph PC["Server"]
    subgraph HV["Hyper-V"]
      HV_app@{ img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRoX960eeNo19hVw8vwsF6ofjcjN8S2IF2tGw&s", label: "", pos: "t", w: 60, h: 60, constraint: "on" }

      subgraph GL["GitLab"]
        GL_app@{ img: "https://upload.wikimedia.org/wikipedia/commons/e/e1/GitLab_logo.svg", label: "", pos: "t", w: 60, h: 60, constraint: "on" }
      end

      subgraph GRW["GitLab Runner (windows)"]
        GRW_app@{ img: "https://gitlab.com/uploads/-/system/project/avatar/250833/runner.png", label: "", pos: "t", w: 60, h: 60, constraint: "on" }
      end

      subgraph GRL["GitLab Runner (linux)"]
        GRL_app@{ img: "https://gitlab.com/uploads/-/system/project/avatar/250833/runner.png", label: "", pos: "t", w: 60, h: 60, constraint: "on" }
      end

      GL <---> GRW
      GL <---> GRL
    end
  end
  CL ---> GL

  style GL fill:#e0095f
  style GRW fill:#e0095f
  style GRL fill:#e0095f
```
