---
title: 【2/5】GitLab+GitLab Runner を構築する道のり
tags:
  - Git
  - PowerShell
  - GitLab
  - Hyper-V
  - CICD
private: false
updated_at: '2025-12-29T23:14:15+09:00'
id: 023019f06e041fcfe907
organization_url_name: null
slide: false
ignorePublish: false
---

# 1. 概要

ここでは、Hyper-V を使って仮想マシンを構築します。
折角なので、マシン情報を標準化するためにスクリプトを用意します。
道のりをたどり始めたばかりのところです。

## 2. ロードマップ

- 1 全体的な説明

https://qiita.com/cipher-31186/items/1e4add84ae5be69ee782

- 2 仮想マシンを構築 ★ 今ここ

https://qiita.com/cipher-31186/items/023019f06e041fcfe907

- 3 GitLab の導入と GitLab Runner の導入

https://qiita.com/cipher-31186/items/cbfb3029ee5c046eb134

- 4 GitLab Runner 設定

https://qiita.com/cipher-31186/items/d803e3a73b1ec7aeefea

- 5 テストラン

https://qiita.com/cipher-31186/items/634f35c1bb9e9399e6b2

# 3. 構築

ここではいくつかの仮想マシンを構築するので、画面をポチポチするのはかったるいなぁと考えていました。  
当初の予定では愚直に画面操作で作る予定でしたが、調べたところ Powershell で実現可能だと！  
まあよく考えたら Hyper-V って「Windows の機能の有効化または無効化」から有効にできるから、Windows でコントロールしやすいだろうし。  
利用した PowerShell は後に記載します。

## 3.1. 前提条件

- ホスト PC で Hyper-V が有効にされていること。
- Hyper-V で外部スイッチが設定されていること。

- 用語説明

| 用語         | 説明                                                                                                       |
| ------------ | ---------------------------------------------------------------------------------------------------------- |
| 外部スイッチ | ホスト PC 以外のマシンから、ホスト PC の NIC を介して仮想マシンへ接続できるようにする設定。                |
| NIC          | ネットワークインターフェースという物理的な部品です。LAN ケーブルを指したり WiFi 接続できるようになります。 |

## 3.2. 仮想マシン構築時の引数

- 各マシンはこのような引数で構築させました。
- ISO ファイル置き場所などの、実行者によって確実に異なる引数は「略」としています。

| 用語                     | 説明                           | GitLab 用      | GitLab Runner (linux) 用 | GitLab Runner (windows) 用 |
| ------------------------ | ------------------------------ | -------------- | ------------------------ | -------------------------- |
| OsName                   | OS 名                          | Ubuntu Desktop | Ubuntu Desktop           | Windows Server             |
| OsVersion                | OS バージョン                  | 24.04.3        | 24.04.3                  | 2019                       |
| VmPurpose                | 入れるアプリ名などの目的を示す | GitLab         | GitLab Runner on Linux   | GitLab Runner on Windows   |
| VmMemoryStartupGigaBytes | 仮想マシンのメモリ(GB 単位)    | 16             | 4                        | 4                          |
| IsoPath                  | OS の iso ファイルのフルパス   | 略             | 略                       | 略                         |
| VMPath                   | 仮想マシン保存場所のフルパス   | 略             | 略                       | 略                         |
| VHDGigaBytesSize         | 仮想 HD のサイズ(GB 単位)      | 50             | 50                       | 50                         |
| VMSwitch                 | 仮想マシンが利用するスイッチ名 | 略             | 略                       | 略                         |
| VMCpuCount               | 仮想マシンの仮想プロセッサ数   | 8              | 4                        | 4                          |

## 3.3. 利用したスクリプト

- より細かく見たいかたは、GitHub に[PSS スクリプト](https://github.com/syachiku-kun/survey-ci-cd/blob/main/01-setup-vm/setup-vm-with-hyperv.ps1)と[スクリプト実行時のログ](https://github.com/syachiku-kun/survey-ci-cd/blob/main/01-setup-vm/setup-vm-with-hyperv_20251229_104312.log)を載せています。
- このログ出力方法は構築前後の比較がしにくいので、全体を Transcript で、前後の結果を各々別ファイルに書き出したりすればいい感じになると思っています。気が向けば改良しようかな...

```powershell
Set-StrictMode -Version 3.0
$PSDefaultParameterValues["*:Encoding"] = "utf8"
$OutputEncoding = [Text.Encoding]::UTF8
[Console]::OutputEncoding = [Text.Encoding]::UTF8
$FileNameWithoutExtension = [System.IO.Path]::GetFileNameWithoutExtension($MyInvocation.MyCommand.name);
$FileLocation = (Split-Path -Path $MyInvocation.MyCommand.Path -Parent)
$Now = Get-Date -Format yyyyMMdd_HHmmss
$LogFileName = "${FileNameWithoutExtension}_${Now}.log"
$LogFile = Join-Path -Path $FileLocation -ChildPath $LogFileName
Start-Transcript $LogFile -append

#----------------------------------------------
# Define variables
# $OsName os name will be used in VM
# $OsVersion os version will be used in VM
# $VmPurpose purpose of the VM
# $VMPath if you want to check existing VMs
# PS C:\Users\xxxxx> Get-VM | Select-Object Name, Path | Format-Table -AutoSize
# Name                   Path
# ----                   ----
# CentOS Stream 9        E:\ProgramData\Microsoft\Windows\Hyper-V\CentOS Stream 9
# Debian 12.7.0          E:\ProgramData\Microsoft\Windows\Hyper-V\Debian 12.7.0
#
# $IsoPath path to the OS ISO file
# $VHDPath path to the VHDX file(auto completed)
# $VMSwitch existing virtual switch name
#----------------------------------------------
$OsName = "Ubuntu Desktop"
$OsVersion = "24.04.3"
$VmPurpose = "GitLab"
$VmName = "${OsName} ${OsVersion}(${VmPurpose})"
$VmMemoryStartupGigaBytes = 4
$IsoPath = "C:\Users\xxxxx\Desktop\system\os\Ubuntu Desktop\ubuntu-24.04.3-desktop-amd64.iso"
$VMPath = "E:\ProgramData\Microsoft\Windows\Hyper-V"
$VHDPath = "$VMPath\$VMName\Virtual Hard Disks\$VMName.vhdx"
$VHDGigaBytesSize = 50
$VMSwitch = "Hyper-V仮想スイッチ（外部）"
$VMCpuCount = 2

# get statue(before)
Get-VM | Select-Object Name, Path | Out-String -Width 4096
Get-Variable | Out-String -Width 4096

# create folder for VM
New-Item -ItemType Directory -Path $VMPath -Force

# create VM(generation 2)
# https://learn.microsoft.com/ja-jp/powershell/module/hyper-v/new-vm
New-VM -Name $VMName `
    -Generation 2 `
    -Path $VMPath `
    -MemoryStartupBytes ([UInt64]$VmMemoryStartupGigaBytes * 1GB) `
    -NewVHDPath $VHDPath `
    -NewVHDSizeBytes ([UInt64]$VHDGigaBytesSize * 1GB) `
    -SwitchName $VMSwitch

# set VM
# https://learn.microsoft.com/ja-jp/powershell/module/hyper-v/set-vm
Set-VM -VMName $vmName `
    -ProcessorCount $VMCpuCount `
    -StaticMemory -AutomaticCheckpointsEnabled $false

# set DVD drive
# https://learn.microsoft.com/ja-jp/powershell/module/hyper-v/add-vmdvddrive
Add-VMDvdDrive -VMName $VMName `
    -Path $IsoPath

# set firmware(boot order, secure boot)
# https://learn.microsoft.com/ja-jp/powershell/module/hyper-v/set-vmfirmware
Set-VMFirmware -VMName $VMName `
    -FirstBootDevice (Get-VMDvdDrive -VMName $VMName) `
    -EnableSecureBoot Off

# create initial checkpoint
# https://learn.microsoft.com/ja-jp/powershell/module/hyper-v/checkpoint-vm
Checkpoint-VM -Name $VMName `
    -SnapshotName "Init Checkpoint"

# get statue(after)
Get-VM | Select-Object Name, Path | Out-String -Width 4096
Get-Variable | Out-String -Width 4096

# start up the VM
# https://learn.microsoft.com/ja-jp/powershell/module/hyper-v/start-vm
Start-VM -Name $VMName

Write-Host "Completed. Press Enter to exit…" -ForegroundColor Yellow
[void] (Read-Host)

Stop-Transcript
```

- このように実行

```
PowerShell 7.5.4
PS C:\Users\whoami> ."C:\Users\whoami\Desktop\git\repositories\syachiku-kun\survey-ci-cd\01-setup-vm\setup-vm-with-hyperv.ps1"
Transcript started, output file is C:\Users\whoami\Desktop\git\repositories\syachiku-kun\survey-ci-cd\01-setup-vm\setup-vm-with-hyperv_20251229_104312.log

Name                   Path
----                   ----
CentOS Stream 9        E:\ProgramData\Microsoft\Windows\Hyper-V\CentOS Stream 9

～～～中略～～～

Completed. Press Enter to exit…                                                                                         ]

Transcript stopped, output file is C:\Users\whoami\Desktop\git\repositories\syachiku-kun\survey-ci-cd\01-setup-vm\setup-vm-with-hyperv_20251229_104312.log

PS C:\Users\whoami>
```

# 目標

2025/12/31 までに「3 GitLab の導入と GitLab Runner の導入」を書く予定です。
